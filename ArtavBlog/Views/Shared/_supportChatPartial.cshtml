<script src="~/js/signalr/dist/browser/signalr.js"></script>
<div class="container chatbox">
    <div class="row pt-3">
        <div class="chat-main">
            <div class="col-md-12 chat-header rounded-top bg-dark text-white">
                <div class="row">
                    <div class="col-md-6 username pl-2">
                        <i class="fa fa-circle text-success" aria-hidden="true"></i>
                        <h6 class="m-0 text-right">پشتیبانی سایت</h6>
                    </div>
                    <div class="col-md-6 options text-left pr-2">
                        <i class="fa fa-times hide-chat-box" aria-hidden="true"></i>
                    </div>
                </div>
            </div>
            <div class="chat-content">
                <div class="col-md-12 chats border">
                    <ul id="support-chatlist" class="p-0">
                        <li class="pl-2 pr-2 bg-primary rounded text-white text-center send-msg mb-1">
                            سلام.چطور میتونم کمکتون کنم؟
                        </li>
                    </ul>
                </div>
                <div class="col-md-12 message-box border pl-2 pr-2 border-top-0">
                    <input id="txt-message" type="text" class="pl-0 pr-0 w-100" placeholder="پیام خود را وارد کنید" />
                    <div class="tools">
                        <button id="btn-send" class="btn btn-dark">
                            ارسال
                        </button> @*<i  class="fas fa-paper-plane m-0"></i>*@
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<style type="text/css">
    .chat-main {
        position: fixed;
        width: 270px;
        bottom: 0;
        right: 200px;
    }

    .chat-header {
        background: #4267B2;
        padding-top: 1px;
        padding-bottom: 1px;
    }

    .username i {
        font-size: 9px;
    }

    .username h6 {
        display: inline-block;
        font-size: 12px;
        font-weight: 600;
    }

    .options i {
        font-size: 14px;
        font-weight: normal;
        opacity: 0.7;
    }

    .options .live-video {
        font-size: 6px;
    }

    .chats {
        height: 260px;
        overflow-x: scroll;
        overflow-x: hidden;
    }

        .chats ul li {
            list-style: none;
            clear: both;
            font-size: 13px;
        }

        .chats .send-msg {
            float: right;
        }

    .receive-msg img {
        border-radius: 100%;
        height: 30px;
        width: 12%;
    }

    .receive-msg-img {
        display: inline;
    }

    .receive-msg .receive-msg-desc {
        display: inline-block;
    }

        .receive-msg .receive-msg-desc p {
            background: #c1c1c1;
        }

    .message-box input {
        border: none;
        font-size: 13px;
        opacity: 0.7;
    }

        .message-box input:focus {
            outline: none;
        }

    .tools i {
        color: #a1a1a1;
        cursor: pointer;
        font-size: 20px;
        margin-right: 6px;
    }

    .chat-content {
        background-color: floralwhite !important;
    }
</style>

<script type="text/javascript">
    $(document).ready(function () {
        var userChatTag = $('<img>').attr('src', '/setting/GetImageByUrl?imageUrl=~/images/app/user.png');
        $('.hide-chat-box').click(function () {
            debugger;
            $('.chat-content').slideToggle();
        });
        var connection = new signalR.HubConnectionBuilder().withUrl("/chatHub").build();
        connection.start().catch(function (e) {
        });
        connection.on("ReceiveMessage", (user, message) => {
            var username = user;
            var messageText = message;
            var li = $('<li>').addClass('pl-2')
                .addClass('rounded')
                .addClass('mb-1')
                .addClass('send-msg')
                .addClass('text-center')
                .addClass('text-white')
                .addClass('bg-primary')
                .addClass('pr-2');
            li.html(messageText)
            $('#support-chatlist').append(li);
            /*
                    <li class="pl-2 pr-2 bg-primary rounded text-white text-center send-msg mb-1">
                                    سلام.چطور میتونم کمکتون کنم؟
                                </li>
                    */

        });

        $('#btn-send').click(function () {
            var message = $('#txt-message').val();
            if (message === '') {
                return;
            }
            $('#txt-message').val('');
              connection.invoke("WebChat", 'Guest', message).catch(err => console.error(err.toString()));
            var li = $('<li>').addClass('p-1').addClass('rounded').addClass('mb-1');//document.createElement("li").classList.add('  ');
            var divParent = $('<div>').addClass('receive-msg');
            li.append(divParent);
            var image = userChatTag;
            divParent.append(image);
            var divChild = $('<div>')
                .addClass('receive-msg-desc')
                .addClass('text-left')
                .addClass('mt-1')
                .addClass('pl-2')
                .addClass('pr-2');
            var pMain = $('<div>').addClass('pl-2').addClass('pr-2').addClass('rounded').html(message);
            divChild.append(pMain);
            divParent.append(divChild);
            li.append(divParent);
            $('#support-chatlist').append(li);
            event.preventDefault();
        });
        $(document).on('onbeforeunload', function () {
            connection.stop().catch(function (e) {
            });
        });


    });
</script>